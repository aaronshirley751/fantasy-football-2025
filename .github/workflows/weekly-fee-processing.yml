name: Weekly Fantasy Football Fee Processing

on:
  # Run every Tuesday at 2 AM EST (after Monday Night Football)
  schedule:
    - cron: '0 7 * * 2'  # 7 AM UTC = 2 AM EST during standard time
  
  # Allow manual triggering with week number input
  workflow_dispatch:
    inputs:
      week_number:
        description: 'NFL Week Number to process'
        required: true
        default: '1'
        type: string
      league_id:
        description: 'League ID (2025 Production)'
        required: false
        default: '1249067741470539776'
        type: string

jobs:
  process-weekly-fees:
    runs-on: ubuntu-latest
    name: Process Fantasy Football Fees
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get current NFL week
      id: get-week
      run: |
        # Calculate current NFL week based on date
        if [ "${{ github.event.inputs.week_number }}" != "" ]; then
          echo "week=${{ github.event.inputs.week_number }}" >> $GITHUB_OUTPUT
        else
          # NFL 2025 season starts September 5th, 2025 (Week 1)
          start_date="2025-09-05"
          current_date=$(date +%Y-%m-%d)
          days_diff=$(( ($(date -d "$current_date" +%s) - $(date -d "$start_date" +%s)) / 86400 ))
          week_number=$(( days_diff / 7 + 1 ))
          
          # Cap at week 18 (regular season)
          if [ $week_number -gt 18 ]; then
            week_number=18
          fi
          if [ $week_number -lt 1 ]; then
            week_number=1
          fi
          
          echo "week=$week_number" >> $GITHUB_OUTPUT
        fi
    
    - name: Process Weekly Fees
      run: |
        echo "ðŸˆ Processing fees for Week ${{ steps.get-week.outputs.week }}"
        echo "ðŸ“Š League ID: ${{ github.event.inputs.league_id || '1249067741470539776' }}"
        
        response=$(curl -s -X POST "https://jfeuobfjgqownybluvje.supabase.co/functions/v1/process-weekly-fees" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -d '{
            "week_number": ${{ steps.get-week.outputs.week }},
            "league_id": "${{ github.event.inputs.league_id || '1249067741470539776' }}"
          }')
        
        echo "ðŸ“‹ Function Response:"
        echo "$response"
        
        # Check if the response contains an error
        if echo "$response" | grep -q '"error"'; then
          echo "âŒ Error processing fees"
          echo "$response"
          exit 1
        else
          echo "âœ… Fees processed successfully"
          
          # Extract key data for summary
          week_total=$(echo "$response" | jq -r '.week_total // "0"')
          season_total=$(echo "$response" | jq -r '.season_grand_total // "0"')
          fee_count=$(echo "$response" | jq -r '.week_fees | length // 0')
          
          echo "week_total=$week_total" >> $GITHUB_OUTPUT
          echo "season_total=$season_total" >> $GITHUB_OUTPUT
          echo "fee_count=$fee_count" >> $GITHUB_OUTPUT
        fi
      id: process-fees
    
    - name: Create Processing Summary
      if: success()
      run: |
        echo "## ðŸˆ Week ${{ steps.get-week.outputs.week }} Fee Processing Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **League ID**: ${{ github.event.inputs.league_id || '1249067741470539776' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Week Number**: ${{ steps.get-week.outputs.week }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Week Total**: \$$${{ steps.process-fees.outputs.week_total }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Season Total**: \$$${{ steps.process-fees.outputs.season_total }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fees Processed**: ${{ steps.process-fees.outputs.fee_count }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Processed At**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "The fee data has been processed and stored in the database." >> $GITHUB_STEP_SUMMARY
        echo "Use the approved Discord formatting script to generate messages if needed." >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on Failure
      if: failure()
      run: |
        echo "## âŒ Week ${{ steps.get-week.outputs.week }} Fee Processing Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **League ID**: ${{ github.event.inputs.league_id || '1249067741470539776' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Week Number**: ${{ steps.get-week.outputs.week }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Failed At**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Check the workflow logs above for detailed error messages" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify the Supabase service role key is configured correctly" >> $GITHUB_STEP_SUMMARY
        echo "3. Ensure the league data is accessible via Sleeper API" >> $GITHUB_STEP_SUMMARY
